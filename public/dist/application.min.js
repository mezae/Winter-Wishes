"use strict";var ApplicationConfiguration=function(){var applicationModuleName="meanww",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","btford.socket-io","textAngular","ngFileUpload"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("emails"),ApplicationConfiguration.registerModule("letters"),ApplicationConfiguration.registerModule("users"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.html"}).state("first",{url:"/settings/profile",templateUrl:"modules/letters/views/firstLogin.html"}).state("confirm",{url:"/settings/profile/first",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("login",{url:"/login",templateUrl:"modules/users/views/authentication/signin.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","$state","$location","$modal","Authentication","socket",function($scope,$state,$location,$modal,Authentication,socket){$scope.authentication=Authentication,$scope.isAdmin=function(){return"admin"===$scope.authentication.user.role},$scope.isActive=function(route){return route===$location.path()},$scope.menuOpened=!1,$scope.toggleMenu=function(event){$scope.menuOpened=!$scope.menuOpened,event.stopPropagation()},window.onclick=function(){$scope.menuOpened&&($scope.menuOpened=!1,$scope.$apply())},$scope.$on("$stateChangeSuccess",function(){0===$scope.authentication.user.status&&$scope.showTutorial()}),$scope.needTutorial=function(){var needTutorial=["command","tracking","agTracking","email","etemplate"],page=$state.current.name;return needTutorial.indexOf(page)>=0},$scope.showTutorial=function(){var page=$state.current.name;if("command"===page)$modal.open({templateUrl:"modules/core/views/adminTutorial.html",controller:"AdminModalController",backdrop:"static"});else if("email"===page)$modal.open({templateUrl:"modules/core/views/emailTutorial.html",controller:"ModalInstanceCtrl",backdrop:"static"});else if("etemplate"===page)$modal.open({templateUrl:"modules/core/views/etemplateTutorial.html",controller:"ModalInstanceCtrl",backdrop:"static"});else if("tracking"===page||"agTracking"===page){var template=$scope.isAdmin()?"modules/core/views/reviewTutorial.html":"modules/core/views/agencyTutorial.html";$modal.open({templateUrl:template,controller:"ModalInstanceCtrl",backdrop:"static"})}}}]).controller("AdminModalController",["$scope","$modalInstance","$filter","Authentication","Users",function($scope,$modalInstance,$filter,Authentication,Users){function init(){$scope.user=Authentication.user,$scope.dueDate=$filter("date")($scope.user.due,"MM/dd/yy")}$scope.saveDueDate=function(){$scope.user.due=$scope.dueDate;var user=new Users($scope.user);user.$update(function(response){Authentication.user=response,init()},function(response){console.log(response.data.message)})},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0},$scope.minDate=new Date,$scope.dateOptions={showWeeks:!1},$scope.exit=function(){$modalInstance.close()},init()}]).controller("ModalInstanceCtrl",["$state","$scope","$filter","$modalInstance","Authentication","Agencies",function($state,$scope,$filter,$modalInstance,Authentication,Agencies){$scope.user=Authentication.user,"agTracking"===$state.current.name&&Agencies.get({agencyId:$scope.user.username},function(tf){$scope.dueDate=$filter("date")(tf.due,"fullDate")}),$scope.ok=function(){$modalInstance.close()}}]),angular.module("core").controller("HomeController",["$scope","$location","Authentication",function($scope,$location,Authentication){function redirect(user){$location.path("admin"===user.role?"/admin":"/agency/"+user.username)}$scope.user=Authentication.user,$scope.user&&redirect($scope.user)}]),angular.module("emails").controller("EmailsController",["$scope","$window","$location","Authentication","Emails",function($scope,$window,$location,Authentication,Emails){$scope.find=function(){$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role?($scope.emails=Emails.query(),$scope.needToUpdate=!1):$location.path("/")},$scope.createTemplate=function(){var email=new Emails($scope.etemplate);email.$save(function(template){$scope.emails.push(template),$scope.hideSidebar()})},$scope.deleteTemplate=function(selected){var confirmation=$window.prompt("Please type DELETE to remove the "+selected.title+" template.");"DELETE"===confirmation&&selected.$remove(function(template){_.remove($scope.emails,selected)})},$scope.showSidebar=function(selected){$scope.etemplate=selected,$scope.needToUpdate=!0},$scope.hideSidebar=function(){$scope.etemplate=null,$scope.needToUpdate=!1}}]),angular.module("emails").controller("EmailController",["$scope","$http","$stateParams","$location","Authentication","Emails",function($scope,$http,$stateParams,$location,Authentication,Emails){$scope.user=Authentication.user,$scope.findOne=function(){$scope.user=Authentication.user,$scope.user?$scope.etemplate=Emails.get({emailId:$stateParams.template}):$location.path("/")},$scope.saveTemplate=function(){$scope.success=$scope.error=null,Emails.update($scope.etemplate,function(response){$scope.etemplate=response,$scope.success=!0},function(response){$scope.error=response})},$scope.sendEmail=function(){$scope.error=null,$scope.saveTemplate(),$http.post("/accept",$scope.etemplate).success(function(response){$location.path("/admin/emails/success")}).error(function(response){$scope.error=response})}}]),angular.module("emails").factory("Emails",["$resource",function($resource){return $resource("emails/:emailId/:controller",{emailId:"@_id"},{update:{method:"PUT"}})}]),angular.module("letters").config(["$compileProvider",function($compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob|chrome-extension):/)}]),angular.module("letters").config(["$stateProvider",function($stateProvider){$stateProvider.state("command",{url:"/admin:status",templateUrl:"modules/letters/views/command.html"}).state("adminSettings",{url:"/admin/settings",templateUrl:"modules/letters/views/settings.html"}).state("manageAdmins",{url:"/admin/settings/manage",templateUrl:"modules/letters/views/settings.manage-admins.html"}).state("tracking",{url:"/admin/agency/:articleId",templateUrl:"modules/letters/views/tracking.html"}).state("agTracking",{url:"/agency/:articleId",templateUrl:"modules/letters/views/tracking.html"}).state("email",{url:"/admin/email",templateUrl:"modules/emails/views/emails.html"}).state("etemplate",{url:"/admin/email/:template",templateUrl:"modules/emails/views/etemplate.html"}).state("email-success",{url:"/admin/emails/success",templateUrl:"modules/emails/views/esent.html"}).state("stats",{url:"/admin/stats",templateUrl:"modules/letters/views/stats.html"})}]),angular.module("letters").controller("CommandController",["$scope","$window","$timeout","$interval","$http","$stateParams","$location","Authentication","Agencies","socket",function($scope,$window,$timeout,$interval,$http,$stateParams,$location,Authentication,Agencies,socket){function signup(credentials){$http.post("/auth/signup",credentials).success(function(response){console.log(response.message)}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})}function signups(file){$http.post("/auth/signups",file).success(function(response){"OK"!==response&&($scope.user=response,$scope.fileDone=!0),$scope.alert.active=!1}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})}function findMissingFields(headers){var required_fields=["Agency Code","Agency Name","Contact Name","Contact E-mail","Accepted Children","Accepted Teens","Accepted Seniors"],missing_fields=[];return _.forEach(required_fields,function(field){_.includes(headers,field)||missing_fields.push(field)}),missing_fields}function processBatch(rows,headers){var rowCount=rows.length;if(rowCount>0){var batchQuantity=rowCount>50?50:rowCount,batch=rows.splice(0,batchQuantity);signups({headers:headers,file:batch,isLast:0===rows.length})}return rows}$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role||$location.path("/").replace(),$location.search()&&($scope.query=$location.search()),$scope.needToUpdate=!1,$scope.alert={active:!1,type:"",msg:""},$scope.updateURL=function(undo){undo&&($scope.query.status=null),$scope.query.status?$location.search("status",$scope.query.status):$location.search("status",null)},$scope.find=function(){$scope.partners=[{username:"Loading...",role:"user"}],socket.syncUpdates("users",$scope.partners),Agencies.query(function(users){$scope.partners=users})},$scope.handleFileSelect=function(){if($scope.file.length){if("text/csv"!==$scope.file[0].type)$scope.alert={active:!0,type:"danger",msg:"Must be a csv file!"};else{var file=$scope.file[0],reader=new FileReader;reader.onload=function(file){var content=file.target.result,rows=content.split(/[\r\n|\n]+/),headers=rows.shift(),missing_fields=findMissingFields(headers);missing_fields.length?$scope.alert={active:!0,type:"danger",msg:"Your csv file could not be uploaded. It is missing the following columns: "+missing_fields.join(", ")+"."}:(headers=headers.split(","),headers={code_col:headers.indexOf("Agency Code"),agency_col:headers.indexOf("Agency Name"),contact_col:headers.indexOf("Contact Name"),email_col:headers.indexOf("Contact E-mail"),child_col:headers.indexOf("Accepted Children"),teen_col:headers.indexOf("Accepted Teens"),seniors_col:headers.indexOf("Accepted Seniors")},$scope.alert={active:!0,type:"info",msg:"Great! Your tracking forms will appear shortly..."},$scope.oldUsers=$scope.partners.length,$scope.newUsers=rows.length,rows=processBatch(rows,headers),$interval(function(){rows=processBatch(rows,headers)},28e3,Math.ceil($scope.newUsers/50)))},reader.readAsText(file),$scope.needToUpdate=!1}$scope.file[0]=void 0}},$scope.saveAgency=function(){$scope.alert.active=!1,$scope.isNewAgency?_.find($scope.partners,{username:$scope.partner.username})?$scope.alert={active:!0,type:"danger",msg:$scope.partner.username+" already exists. Please edit the existing copy to avoid duplicates."}:signup($scope.partner):Agencies.update($scope.partner),$scope.hideSidebar()},$scope.deleteAgency=function(selected){var confirmation=$window.prompt("Please type DELETE to remove "+selected.agency+".");"DELETE"===confirmation&&$http["delete"]("/agency/"+selected.username)},$scope.showSidebar=function(selected){$scope.isNewAgency=selected?!1:!0,$scope.partner=selected,$scope.needToUpdate=!0,$scope.startSearch=!1},$scope.hideSidebar=function(){$scope.partner=null,$scope.needToUpdate=!1,($scope.query.username||$scope.query.status)&&($scope.startSearch=!0)},$scope.$on("$destroy",function(){socket.unsyncUpdates("users")})}]),angular.module("letters").controller("myController",["$scope","$window","$location","$filter","$http","Authentication","Users","Agencies","Articles",function($scope,$window,$location,$filter,$http,Authentication,Users,Agencies,Articles){function signup(credentials){$http.post("/auth/newadmin",credentials).success(function(response){console.log("new admin added"),$scope.newAdmin=!1}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})}$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role||$location.path("/").replace(),$scope.users=Agencies.query({role:"admin"}),$scope.viewData=function(tab){$scope.setting=tab,$scope.calendar={startDate:null,endDate:null,opened:{},dateFormat:"MM/dd/yyyy",dateOptions:{showWeeks:!1},open:function($event,calID){$event.preventDefault(),$event.stopPropagation(),$scope.calendar.opened[calID]=!0}}},$scope.saveDueDate=function(){var user=new Users($scope.user);user.$update(function(response){$scope.user=response},function(response){console.log(response.data.message)})},$scope.viewAdmins=function(){$scope.setting="admins",$scope.credentials={}},$scope.viewNotifications=function(){$scope.setting="notify",$scope.permission="granted"===Notification.permission},$scope.downloadCSV=function(){if($scope.error=null,$scope.total=null,$scope.calendar.startDate&&$scope.calendar.endDate)if($scope.calendar.startDate>$scope.calendar.endDate)$scope.error="Start date must come before or be equal to end date.";else{var headers=["track","type","name","age","gender","gift"];headers.push("flagged");var csvString=headers.join(",")+"\r\n",Recipients=Articles.query({start:$scope.calendar.startDate,end:$scope.calendar.endDate},function(){$scope.total=Recipients.length,_.forEach(Recipients,function(letter){var type=letter.track.charAt(3);letter.type="C"===type?"child":"T"===type?"teen":"senior",_.forEach(headers,function(key){var line=letter[key];"gift"===key&&_.indexOf(letter[key],",")&&(line='"'+letter[key]+'"'),csvString+=line+","}),csvString+="\r\n"});var date=$filter("date")(new Date,"MM-dd");$scope.fileName="WishesToSF_"+date+".csv";var blob=new Blob([csvString],{type:"text/csv;charset=UTF-8"});$scope.url=$window.URL.createObjectURL(blob)})}else $scope.error="Please enter a start date and an end date."},$scope.saveAdmin=function(){console.log($scope.credentials),signup($scope.credentials)},$scope.allowNotifications=function(){"Notification"in window?"denied"!==Notification.permission&&Notification.requestPermission(function(permission){if("granted"===permission){$scope.permission=!0;{new Notification("Hi there!")}}}):alert("This browser does not support desktop notification")},$scope.reset=function(){var confirmation=$window.prompt("Please type FOREVER to wipe all data.");"FOREVER"===confirmation&&$http.get("/users/reset").success(function(response){Authentication.user=response,$scope.user.status=0,Users.update($scope.user)}).error(function(response){$scope.error=response.message})}}]),angular.module("letters").controller("ManageAdminsController",["$scope","$window","$location","$http","Authentication","Users","Agencies",function($scope,$window,$location,$http,Authentication,Users,Agencies){$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role||$location.path("/").replace(),$scope.find=function(){$scope.credentials={},$scope.alert={active:!1,type:"",msg:""},$scope.users=Agencies.query({role:"admin"})},$scope.addAdmin=function(){$http.post("/auth/newadmin",$scope.credentials).success(function(response){$scope.users.push(response),$scope.alert.active&&($scope.alert.active=!1),$scope.credentials=null}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})},$scope.removeAdmin=function(selected){var confirmation=$window.prompt("Type DELETE to remove "+selected.username+"'s account");if("DELETE"===confirmation){var oldAdmin=selected;selected.$remove(function(){$scope.users.splice(_.findIndex($scope.users,oldAdmin),1)})}}}]),angular.module("letters").controller("SummaryController",["$scope","$window","$location","$filter","Authentication","Agencies","Articles",function($scope,$window,$location,$filter,Authentication,Agencies,Articles){$scope.authentication=Authentication,$scope.authentication.user||$location.path("/"),angular.element($window).on("resize",function(){$scope.$apply()}),Agencies.query(function(users){var names=["Not Yet Started","In Progress","Completed","Submitted","Under Review","Reviewed"],groups=_.countBy(users,function(form){return form.status});$scope.status=[],_.forEach(groups,function(c,g){$scope.status.push({status:g,name:names[g],count:c,percent:(c/users.length*100).toFixed(1)+"%"})})}),Articles.query(function(useful){if(useful.length>0){var counts=_.countBy(useful,function(letter){return $filter("date")(letter.updated,"yyyy-MM-dd")}),activeDays=[];_.forEach(counts,function(count,date){activeDays.push(date)}),activeDays=activeDays.sort(function(a,b){return a>b}),$scope.wishesAdded=[];var current=activeDays[0],endDate=new Date;for(endDate.setDate(endDate.getDate()+1),endDate=$filter("date")(endDate,"yyyy-MM-dd");current!==endDate;)$scope.wishesAdded.push({date:String(current),count:counts[current]?counts[current]:0}),current=new Date(current),current.setDate(current.getDate()+2),current=$filter("date")(current,"yyyy-MM-dd");var wordCounts=[],fillers=" , a, an, and, but, or, the, this, that, for, is, it, my, your, i, am, is, be, you, me, it, he, she, to, please, dont, who, what, where, when, why, how, which, with";_.forEach(useful,function(letter){var words=_.words(letter.gift);_.forEach(words,function(word){if(word=word.toLowerCase(),!_.includes(fillers,word)){var cc=_.find(wordCounts,{name:word});cc?cc.value+=1:wordCounts.push({name:word,value:1})}})});var sorted=_.sortBy(wordCounts,function(word){return-word.value});$scope.gifts=_.take(sorted,10)}else $scope.wishesAdded=[],$scope.gifts=[]})}]),angular.module("letters").controller("AgencyController",["$scope","$q","$stateParams","$location","$anchorScroll","$filter","$timeout","$modal","Authentication","Articles","Agencies","Users",function($scope,$q,$stateParams,$location,$anchorScroll,$filter,$timeout,$modal,Authentication,Articles,Agencies,Users){function showCountdown(deadline){var countdown=dateDiff(new Date,new Date(deadline));$scope.alert={active:!1,type:null,msg:null},14===countdown?$scope.alert={type:"warning",msg:"Two weeks left"}:7===countdown?$scope.alert={type:"warning",msg:"One week left"}:0===countdown?$scope.alert={type:"danger",msg:"Last day to submit"}:1===countdown?$scope.alert={type:"danger",msg:"One day left"}:0>countdown?$scope.alert={type:"danger",msg:"Past due -- please submit it ASAP"}:3>=countdown&&($scope.alert={type:"danger",msg:countdown+" days left"}),$scope.alert.active=null!==$scope.alert.msg}function init(){$scope.tabs=[{title:"Children",content:$scope.currentAgency.children,active:!1,minAge:4,maxAge:13},{title:"Teens",content:$scope.currentAgency.teens,active:!1,minAge:14,maxAge:18},{title:"Seniors",content:$scope.currentAgency.seniors,active:!1,minAge:65,maxAge:125}],$scope.activateTab($scope.currentAgency.children>0?$scope.tabs[0]:$scope.currentAgency.teens>0?$scope.tabs[1]:$scope.tabs[2]),(!$scope.adminView&&$scope.currentAgency.status>=3||$scope.adminView&&5===$scope.currentAgency.status)&&downloadCSV()}function dateDiff(a,b){var MS_PER_DAY=864e5,utc1=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),utc2=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate());return Math.floor((utc2-utc1)/MS_PER_DAY)}function updateForm(form){form&&(form.$setPristine(),form.$setUntouched()),$scope.current=$scope.recipients[currentIndex],currentIndex%10===9&&($location.hash(currentIndex+1),$anchorScroll());var limit=50;currentIndex%limit===limit-15&&$scope.recipients.length<$scope.currentTab.content&&$scope.loadMore(currentIndex+15)}function isValidLetter(form){return $scope.current.name||$scope.current.age||$scope.current.gender||$scope.current.gift?$scope.current.name&&$scope.current.age&&$scope.current.gender&&$scope.current.gift?(addRecipient(form),!0):($scope.blankName=!$scope.current.name,$scope.error="fields cannot be left blank",$timeout(function(){$scope.blankName=!1,$scope.error=null},2e3),!1):!0}function addRecipient(form){if($scope.current.name=cleanText($scope.current.name,1).trim(),$scope.current.gender=$scope.current.gender.toUpperCase(),$scope.current.gift=cleanText($scope.current.gift,2),0===$scope.currentAgency.status){$scope.currentAgency.status=1;var user=new Users($scope.currentAgency);user.$update(function(response){$scope.currentAgency=response})}$scope.current.$update()}function cleanText(text,priority){return text!==text.toLowerCase()&&text!==text.toUpperCase()||1!==priority?text===text.toUpperCase()?text.toLowerCase():text:text.replace(/\w\S*/g,function(txt){return _.capitalize(txt)})}function downloadCSV(){var headers=["track","name","age","gender","gift"];$scope.adminView&&headers.push("flagged");var csvString=headers.join(",")+"\r\n",Recipients=Articles.query({username:$stateParams.articleId},function(){_.forEach(Recipients,function(letter){letter.name&&(_.forEach(headers,function(key){var line=letter[key];"gift"===key&&_.indexOf(letter[key],",")&&(line='"'+letter[key]+'"'),csvString+=line+","}),csvString+="\r\n")});var date=$filter("date")(new Date,"MM-dd");$scope.fileName="WishesToSF_"+$scope.currentAgency.username+"_"+date+".csv";var blob=new Blob([csvString],{type:"text/csv;charset=UTF-8"});$scope.url=window.URL.createObjectURL(blob)})}function rateAgencyToComplete(){var modalInstance=$modal.open({templateUrl:"modules/letters/views/rating.html",controller:"RatingCtrl",backdrop:"static",size:"md",resolve:{rating:function(){return $scope.currentAgency.rating}}});modalInstance.result.then(function(result){$scope.currentAgency.rating=result,$scope.currentAgency.status=5;var user=new Agencies($scope.currentAgency);user.$update(function(response){$scope.currentAgency=response,downloadCSV()},function(response){$scope.error=response.data.message})})}$scope.user=Authentication.user,$scope.user||$location.path("/"),console.log($scope.user),$scope.adminView="user"!==$scope.user.role,$scope.userView="user"===$scope.user.role;var currentIndex=0;$scope.find=function(){$scope.adminView?$scope.currentAgency=Agencies.get({agencyId:$stateParams.articleId},function(){init()}):($scope.currentAgency=$scope.user,init(),Agencies.query({role:"admin"},function(admin){$scope.currentAgency.status<3&&showCountdown(admin[0].due)})),console.log($scope.currentAgency)},$scope.activateTab=function(clicked,form){$scope.currentTab=clicked,clicked.active=!0,$scope.recipients=Articles.query({username:$stateParams.articleId+clicked.title.charAt(0),limit:50},function(){$scope.minAge=clicked.minAge,$scope.maxAge=clicked.maxAge;var blankRecord=_.findIndex($scope.recipients,{name:""});currentIndex=blankRecord?blankRecord:0,updateForm(form)})},$scope.addBlank=function(){var letter=new Articles({track:$scope.current.track});letter.$save(function(response){Articles.query({username:$stateParams.articleId+$scope.currentTab.title.charAt(0),limit:$scope.recipients.length},function(letters){$scope.recipients=letters})},function(errorResponse){console.log("response")})},$scope.clearForm=function(selected){$scope.adminView?selected.$remove(function(response){Articles.query({username:$stateParams.articleId+$scope.currentTab.title.charAt(0),limit:$scope.recipients.length},function(letters){$scope.recipients=letters})},function(errorResponse){console.log("Remove Failed")}):($scope.current.name="",$scope.current.age="",$scope.current.gender="",$scope.current.gift="",$scope.current.$update())},$scope.loadMore=function(records){Articles.query({username:$stateParams.articleId+$scope.currentTab.title.charAt(0),offset:records,limit:50},function(letters){$q.all([$scope.recipients,letters]).then(function(data){$scope.recipients=data[0].concat(data[1])})})},$scope.goToNext=function(form){isValidLetter(form)&&(currentIndex<$scope.recipients.length-1?(currentIndex++,updateForm(form)):$scope.alert={active:!0,type:"info",msg:"You just entered the last letter on this page."})},$scope.goToSelected=function(selected,form){isValidLetter(form)&&!form.$invalid&&(currentIndex=selected,updateForm(form))},$scope.isUsed=function(form){$scope.current.name?($scope.blankName=!1,form.age.$setTouched(),form.gender.$setTouched(),form.gift.$setTouched()):form.$setUntouched()},$scope.isWithinRange=function(age){age.$setValidity("inRange",null===$scope.current.age||$scope.current.age>=$scope.minAge&&$scope.current.age<=$scope.maxAge)},$scope.confirmCompletion=function(){var user=null;if($scope.adminView)rateAgencyToComplete();else{var dblcheck=confirm("Click OK to let the Winter Wishes Team know that your tracking form is ready. You will not be able to make any further changes.");dblcheck&&($scope.currentAgency.status=3,user=new Users($scope.currentAgency),user.$update(function(response){$scope.currentAgency=response,downloadCSV()},function(response){$scope.error=response.data.message}))}},$scope.startReview=function(){$scope.currentAgency.status=4;var user=new Agencies($scope.currentAgency);user.$update(function(response){$scope.currentAgency=response},function(response){$scope.error=response.data.message})},$scope.flagLetter=function(selected){selected.flagged=!selected.flagged,selected.$update()},$scope.returnLetters=function(){$scope.currentAgency.status=1;var user=new Agencies($scope.currentAgency);user.$update(function(response){$scope.currentAgency=response},function(response){$scope.error=response.data.message})},$scope.giftReceived=function(selected){selected.received=!selected.received,selected.$update()}}]).controller("RatingCtrl",["$scope","$timeout","$modalInstance","rating",function($scope,$timeout,$modalInstance,rating){$scope.rating=rating,$scope.hoveringOver=function(value,rating){switch($scope.overStar=value,$scope.desc={percent:100*(value/5)},value){case 1:$scope.desc.words="None";break;case 2:$scope.desc.words="Scarce";break;case 3:$scope.desc.words="Some";break;case 4:$scope.desc.words="Good";break;case 5:$scope.desc.words="Great"}$scope.active=rating},$scope.updateOverall=function(){$scope.rating.overall=($scope.rating.content+$scope.rating.decoration)/2},$scope.ok=function(){$scope.rating.overall>0?$modalInstance.close($scope.rating):($scope.error="your feedback would be greatly appreciated",$timeout(function(){$scope.error=null},2e3))}}]),angular.module("letters").directive("activity",function(){return{restrict:"E",scope:{data:"="},link:function(scope,elem){var element=elem[0],margin={top:20,right:30,bottom:40,left:40},width=element.clientWidth-margin.left-margin.right,height=300-margin.top-margin.bottom,count=0;scope.$watch("data",function(data){if(data&&1>count){count++;var parseDate=d3.time.format("%Y-%m-%d").parse,formatTime=d3.time.format("%B %e");data.forEach(function(d){d.date=parseDate(d.date)});var x=d3.time.scale().range([0,width]),y=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).ticks(d3.time.week,1).tickFormat(d3.time.format("%m/%d")).orient("bottom"),yAxis=d3.svg.axis().scale(y).ticks(5).tickFormat(d3.format("d")).tickSubdivide(0).orient("left"),div=d3.select("body").append("div").attr("class","timeTooltip").style("opacity",0),line=d3.svg.line().x(function(d){return x(d.date)}).y(function(d){return y(d.count)});x.domain(d3.extent(data,function(d){return d.date})),y.domain(d3.extent(data,function(d){return d.count}));var chart=d3.select(element).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");chart.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(d){return"rotate(-65)"}),chart.append("g").attr("class","y axis").call(yAxis),chart.append("text").attr("transform","rotate(-90)").attr("y",0-margin.left).attr("x",0-height/2).attr("dy","1em").style("text-anchor","middle").text("# of Wishes Added"),chart.append("path").datum(data).attr("class","line").attr("d",line),chart.selectAll("dot").data(data.filter(function(d){return d.count>0})).enter().append("circle").attr("class","circle").attr("r",3.5).attr("cx",function(d){return x(d.date)}).attr("cy",function(d){return y(d.count)}).on("mouseover",function(d){div.transition().duration(500).style("opacity",0),div.transition().duration(200).style("opacity",.8),div.html(formatTime(d.date)+"<br/>Wishes Added: "+d.count).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(d){div.transition().duration(1e3).style("opacity",0)})}},!0)}}}),angular.module("letters").factory("Agencies",["$resource",function($resource){return $resource("agency/:agencyId",{agencyId:"@username"},{update:{method:"PUT"}})}]),angular.module("letters").directive("donut",["$location",function($location){return{restrict:"E",scope:{data:"="},link:function(scope,elem){var element=elem[0],width=element.clientWidth,height=320,outerRadius=(Math.min(width,height)/2,height/2-20),innerRadius=outerRadius/2;scope.$watch("data",function(data){if(data){var color=d3.scale.ordinal().range(["#cd4d52","#cd884d","#85c739","#4d92cd","#7b39c7"]),pie=d3.layout.pie().padAngle(.01).sort(null).value(function(d){return d.count}),arc=d3.svg.arc().padRadius(outerRadius).innerRadius(innerRadius),div=d3.select("body").append("div").attr("class","donutTooltip").style("opacity",0),svg=d3.select(element).append("svg").attr("width",width).attr("height",height),chart=svg.append("g").attr("transform","translate("+width/2+","+(height/2-20)+")");data.forEach(function(d){d.count=+d.count});var g=chart.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc");g.append("path").each(function(d){d.outerRadius=outerRadius-10}).attr("d",arc).style("fill",function(d){return color(d.data.status)}).style("cursor","pointer").on("mouseover",function(d){d3.select(this).transition().delay(0).attrTween("d",function(d){var i=d3.interpolate(d.outerRadius,outerRadius-2);return function(t){return d.outerRadius=i(t),arc(d)}}),div.transition().duration(0).style("opacity",0),div.transition().duration(200).style("opacity",.8),div.html(d.data.name+": "+d.data.count).style("left",d3.event.pageX+14+"px").style("top",d3.event.pageY+14+"px")}).on("mousemove",function(){div.style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY+16+"px")}).on("mouseout",function(d){d3.select(this).transition().delay(100).attrTween("d",function(d){var i=d3.interpolate(d.outerRadius,outerRadius-10);return function(t){return d.outerRadius=i(t),arc(d)}}),div.transition().duration(1e3).style("opacity",0)}).on("click",function(d){window.location.href="/#!/admin?status="+d.data.status}),g.append("text").attr("transform",function(d){return"translate("+arc.centroid(d)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(d){return d.data.percent}),chart.append("text").attr("class","donutTitle").style("text-anchor","middle").text("Progress");var legendContainer=svg.append("g").attr("transform","translate(10,"+(height-30)+")"),legend=legendContainer.append("g").attr("class","legend"),series=legend.selectAll(".series").data(pie(data)),seriesEnter=series.enter().append("g").attr("class","series");seriesEnter.append("circle").style("fill",function(d,i){return color(d.data.status)}).attr("r",5),seriesEnter.append("text").style("fill","black").text(function(d){return d.data.name}).attr("text-anchor","start").attr("dy",".32em").attr("dx","8");var xpos,ypos=5,newxpos=35,maxwidth=0;series.attr("transform",function(d,i){var length=legendContainer.selectAll("text")[0][i].getComputedTextLength()+28;return xpos=newxpos,xpos+length>width&&(newxpos=xpos=35,ypos+=20),newxpos+=length,newxpos>maxwidth&&(maxwidth=newxpos),"translate("+xpos+","+ypos+")"})}},!0)}}}]),angular.module("letters").factory("Articles",["$resource",function($resource){return $resource("articles/:articleId/:controller",{articleId:"@_id"},{update:{method:"PUT"}})}]),angular.module("letters").factory("socket",["socketFactory",function(socketFactory){var ioSocket=io("",{
path:"/socket.io-client"}),socket=socketFactory({ioSocket:ioSocket});return{socket:socket,syncUpdates:function(modelName,array,cb){cb=cb||angular.noop,socket.on(modelName+":save",function(item){var oldItem=_.find(array,{_id:item._id}),index=array.indexOf(oldItem),event="created";if(oldItem?(array.splice(index,1,item),event="updated"):array.push(item),3===item.status){var message=item.agency+" just submitted their tracking form.",options={body:message,icon:"http://img3.wikia.nocookie.net/__cb20141010004359/disney/images/4/49/Baymax_Armor_Wings_Render.png",dir:"ltr",tag:"submitted"},notification=new Notification("Quick Update",options);notification.onclick=function(){window.open("https://winterwishes.herokuapp.com/#!/")}}cb(event,item,array)}),socket.on(modelName+":remove",function(item){var event="deleted";_.remove(array,{_id:item._id}),cb(event,item,array)})},unsyncUpdates:function(modelName){socket.removeAllListeners(modelName+":save"),socket.removeAllListeners(modelName+":remove")}}}]),angular.module("letters").directive("donutChart",function(){return{restrict:"E",scope:{data:"="},link:function(scope,elem){var element=elem[0],margin={top:20,right:30,bottom:30,left:55},width=element.clientWidth-margin.left-margin.right,height=300-margin.top-margin.bottom;scope.$watch("data",function(data){if(data){var y=d3.scale.ordinal().domain(data.map(function(d){return d.name})).rangeRoundBands([height,0],.05),x=d3.scale.linear().domain([0,d3.max(data,function(d){return d.value})]).range([0,width]),yAxis=d3.svg.axis().scale(y).orient("left"),chart=d3.select(element).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");chart.append("g").attr("class","y axis").call(yAxis),chart.selectAll(".bar").data(data).enter().append("rect").attr("class","bar").attr("y",function(d){return y(d.name)}).attr("width",function(d){return x(d.value)}).attr("height",y.rangeBand()),chart.selectAll(".btext").data(data).enter().append("text").attr("class","btext").attr("x",function(d){return x(d.value)-3}).attr("y",function(d){return y(d.name)+y.rangeBand()/2}).attr("dy",".35em").text(function(d){return d.value})}},!0)}}}),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile/edit",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$state","Authentication",function($scope,$http,$state,Authentication){function redirect(user){"admin"===user.role?$state.go("command"):0===user.status?$state.go("first"):$state.go("agTracking",{articleId:user.username})}$scope.user=Authentication.user,$scope.user&&redirect($scope.user),$scope.signin=function(form){$http.post("/auth/signin",$scope.credentials).success(function(response){Authentication.user=response,$scope.user=Authentication.user,redirect($scope.user)}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){$scope.success=$scope.error=null,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.isFirstLogin="/settings/profile/first"===$location.path(),$scope.user||$location.path("/"),$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response;var newPage=$scope.isFirstLogin?"/settings/profile":"/";$location.path(newPage)},function(response){$scope.error=response.data.message})}else $scope.submitted=!0},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);